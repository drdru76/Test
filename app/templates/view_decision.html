{% extends "base.html" %}

{% block content %}
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ decision.title }}</li>
                </ol>
            </nav>

            <div class="decision-header-card p-4 p-md-5 mb-5 shadow-sm">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
                    <div>
                        <h1 class="display-4 fw-bold mb-0 text-gradient">{{ decision.title }}</h1>
                    </div>
                    {% if decision.owner == current_user or current_user.is_admin %}
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('main.edit_decision', id=decision.id) }}" class="btn btn-primary shadow-sm">
                            <i class="fas fa-edit me-1"></i> Edit
                        </a>
                        <form action="{{ url_for('main.delete_decision', id=decision.id, next=url_for('main.index')) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this ENTIRE decision process? This cannot be undone.');">
                            <button type="submit" class="btn btn-outline-danger shadow-sm">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>

                <div class="d-flex flex-wrap align-items-center gap-2 mt-4">
                    <span class="badge rounded-pill bg-light text-dark border shadow-sm px-3 py-2">
                        <i class="far fa-calendar-alt me-1 text-primary"></i> Deadline: {{ decision.deadline.strftime('%Y-%m-%d') if decision.deadline else 'Not set' }}
                    </span>
                    <span class="badge rounded-pill bg-primary text-white shadow-sm px-3 py-2">
                        <i class="fas fa-tasks me-1"></i> Stage: 
                        {% for value, label in decision.STAGES %}
                            {% if value == decision.stage %}
                                {{ label }}
                            {% endif %}
                        {% endfor %}
                    </span>
                    <span class="badge rounded-pill {% if decision.status == 'completed' %}bg-success text-white{% else %}bg-secondary text-white{% endif %} shadow-sm px-3 py-2">
                        <i class="fas fa-info-circle me-1"></i> Status: {{ decision.status|capitalize }}
                    </span>
                    {% if decision.category %}
                    <a href="{{ url_for('main.index', category=decision.category) }}" class="badge rounded-pill bg-light text-primary border shadow-sm px-3 py-2 text-decoration-none hover-shadow">
                        <i class="fas fa-tag me-1"></i> {{ decision.category }}
                    </a>
                    {% endif %}
                    {% if decision.is_public %}
                    <span class="badge rounded-pill bg-info text-white shadow-sm px-3 py-2">
                        <i class="fas fa-globe me-1"></i> Public
                    </span>
                    {% endif %}
                </div>
            </div>

            <section class="mb-5">
                <h2 class="h4 mb-4"><i class="fas fa-tasks me-2 text-primary"></i>Decision Stages Details</h2>
                <div class="accordion shadow-sm" id="stagesAccordion">
                    {% for value, label in stages %}
                    {% set stage_num = value.split('_')[0] %}
                    {% set stage_content_attr = 'stage_' + value %}
                    {% set stage_content = getattr(decision, stage_content_attr) %}
                    <div class="accordion-item border-0 mb-3 rounded overflow-hidden">
                        <h2 class="accordion-header" id="heading{{ stage_num }}">
                            <button class="accordion-button {% if not stage_content %}collapsed{% endif %} py-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ stage_num }}" aria-expanded="{% if stage_content %}true{% else %}false{% endif %}" aria-controls="collapse{{ stage_num }}">
                                <span class="badge rounded-pill {% if decision.stage == value %}bg-primary{% else %}bg-secondary{% endif %} me-3">{{ stage_num }}</span>
                                <span class="fw-bold {% if decision.stage == value %}text-primary{% endif %}">{{ label }}</span>
                                {% if decision.stage == value %}
                                <span class="badge bg-primary-subtle text-primary border border-primary-subtle ms-3 small">Current Stage</span>
                                {% endif %}
                                {% if stage_content %}
                                <i class="fas fa-check-circle text-success ms-auto me-3" title="Content added"></i>
                                {% endif %}
                            </button>
                        </h2>
                        <div id="collapse{{ stage_num }}" class="accordion-collapse collapse {% if stage_content %}show{% endif %}" aria-labelledby="heading{{ stage_num }}" data-bs-parent="#stagesAccordion">
                            <div class="accordion-body bg-white p-4">
                                <div class="row">
                                    <div class="col-lg-4">
                                        <!-- Stage Guidance -->
                                        {% if stage_details and value in stage_details %}
                                        <div class="stage-guidance mb-4 p-3 bg-light border-start border-primary border-4 rounded-end">
                                            <h5 class="h6 fw-bold text-primary mb-2">{{ stage_details[value]['quote'] }}</h5>
                                            <ul class="small text-muted mb-2 ps-3">
                                                {% for bullet in stage_details[value]['bullets'] %}
                                                <li>{{ bullet }}</li>
                                                {% endfor %}
                                            </ul>
                                            <div class="small text-danger mt-2">
                                                <i class="fas fa-exclamation-triangle me-1"></i> <strong>Risk here:</strong> {{ stage_details[value]['risk'] }}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-lg-8">
                                        <div id="display-{{ value }}" class="stage-display mb-3">
                                            {% if stage_content %}
                                                <div class="p-3 bg-light rounded border">
                                                    {{ stage_content|safe }}
                                                </div>
                                            {% else %}
                                                <p class="text-muted italic">No content yet for this stage.</p>
                                            {% endif %}
                                        </div>

                                        <div id="ai-comparison-{{ value }}" class="ai-comparison d-none mb-3">
                                            <div class="card border-magic">
                                                <div class="card-header bg-magic text-white d-flex justify-content-between align-items-center">
                                                    <span><i class="fas fa-robot me-2"></i>AI Suggested Improvement</span>
                                                    <button type="button" class="btn-close btn-close-white" onclick="closeAiComparison('{{ value }}')" aria-label="Close"></button>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row g-3">
                                                        <div class="col-md-6">
                                                            <h6 class="fw-bold text-muted mb-2">Current Content</h6>
                                                            <div class="p-3 border rounded bg-light small" style="max-height: 300px; overflow-y: auto;">
                                                                {% if stage_content %}
                                                                    {{ stage_content|safe }}
                                                                {% else %}
                                                                    <span class="text-muted italic">Empty</span>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <h6 class="fw-bold text-magic mb-2">AI Suggestion</h6>
                                                            <div id="ai-suggestion-content-{{ value }}" class="p-3 border border-magic rounded bg-magic-subtle small" style="max-height: 300px; overflow-y: auto;">
                                                                <!-- AI content goes here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex gap-2 mt-3 justify-content-end">
                                                        <button class="btn btn-outline-secondary btn-sm" onclick="closeAiComparison('{{ value }}')">Discard</button>
                                                        <button class="btn btn-magic btn-sm" id="apply-ai-{{ value }}" onclick="applyAiSuggestion('{{ value }}')">
                                                            <i class="fas fa-check me-1"></i> Use Suggestion
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {% if decision.owner == current_user or current_user.is_admin %}
                                        {% set stage_suggestions = decision.stage_suggestions.filter_by(stage_key=value, status='pending').all() %}
                                        {% if stage_suggestions %}
                                        <div class="stage-suggestions-contextual mb-3">
                                            <h6 class="fw-bold text-warning small mb-2"><i class="fas fa-lightbulb me-1"></i>Pending Suggestions for this Stage:</h6>
                                            {% for sug in stage_suggestions %}
                                            <div class="card border-warning border-opacity-25 mb-2 shadow-sm">
                                                <div class="card-body p-2 small">
                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                        <a href="{{ url_for('main.user', username=sug.author.username) }}" class="fw-bold text-decoration-none">
                                                            {{ sug.author.username }}
                                                        </a>
                                                        <span class="text-muted" style="font-size: 0.7rem;">{{ sug.created_at.strftime('%Y-%m-%d') }}</span>
                                                    </div>
                                                    <div class="mb-2 border p-2 bg-light rounded" style="max-height: 80px; overflow-y: auto;">
                                                        {{ sug.content|safe }}
                                                    </div>
                                                    <div class="d-flex gap-2">
                                                        <form action="{{ url_for('main.accept_stage_suggestion', id=sug.id) }}" method="post">
                                                            <button type="submit" class="btn btn-success btn-sm py-0 px-2" style="font-size: 0.7rem;">
                                                                <i class="fas fa-check me-1"></i> Accept
                                                            </button>
                                                        </form>
                                                        <form action="{{ url_for('main.ignore_stage_suggestion', id=sug.id) }}" method="post">
                                                            <button type="submit" class="btn btn-outline-secondary btn-sm py-0 px-2" style="font-size: 0.7rem;">Ignore</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        
                                        <div id="edit-{{ value }}" class="stage-edit d-none">
                                            <div id="editor-{{ value }}" style="height: 200px;" class="mb-3"></div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-primary btn-sm" onclick="saveStage('{{ value }}')">
                                                    <i class="fas fa-save me-1"></i> Save
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm" onclick="toggleEdit('{{ value }}')">Cancel</button>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2 mt-3">
                                            <button class="btn btn-outline-primary btn-sm" onclick="toggleEdit('{{ value }}')">
                                                <i class="fas fa-edit me-1"></i> {% if stage_content %}Edit{% else %}Add Content{% endif %}
                                            </button>
                                            <button class="btn btn-outline-magic btn-sm" id="ai-btn-{{ value }}" onclick="aiAssist('{{ value }}')">
                                                <i class="fas fa-magic me-1"></i> AI Assist
                                            </button>
                                        </div>
                                        {% elif current_user.is_authenticated %}
                                        <div id="suggest-{{ value }}" class="stage-suggest d-none">
                                            <div id="suggest-editor-{{ value }}" style="height: 200px;" class="mb-3"></div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-warning btn-sm" onclick="submitSuggestion('{{ value }}')">
                                                    <i class="fas fa-paper-plane me-1"></i> Submit Suggestion
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm" onclick="toggleSuggest('{{ value }}')">Cancel</button>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button class="btn btn-outline-warning btn-sm" onclick="toggleSuggest('{{ value }}')">
                                                <i class="fas fa-lightbulb me-1"></i> Suggest Improvement
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>

            {% set pending_stage_suggestions = decision.stage_suggestions.filter_by(status='pending').all() %}
            {% if (decision.owner == current_user or current_user.is_admin) and pending_stage_suggestions %}
            <section class="mb-4">
                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="card border-warning border-opacity-25 shadow-sm h-100">
                            <div class="card-header bg-warning bg-opacity-10 border-warning border-opacity-25">
                                <h2 class="h6 mb-0 text-warning"><i class="fas fa-lightbulb me-2"></i>Pending Stage Suggestions</h2>
                            </div>
                            <div class="list-group list-group-flush">
                                {% for sug in pending_stage_suggestions %}
                                <div class="list-group-item p-3">
                                    <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                                        <div>
                                            <span class="badge bg-secondary me-2">{{ sug.stage_key|replace('_', ' ')|title }}</span>
                                            <a href="{{ url_for('main.user', username=sug.author.username) }}" class="badge bg-info text-white rounded-pill text-decoration-none" title="View Profile">
                                                <i class="fas fa-user me-1"></i> {{ sug.author.username }}
                                            </a>
                                        </div>
                                        <small class="text-muted">{{ sug.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <div class="mb-3 small border p-2 bg-light rounded" style="max-height: 100px; overflow-y: auto;">
                                        {{ sug.content|safe }}
                                    </div>
                                    <div class="d-flex gap-2">
                                        <form action="{{ url_for('main.accept_stage_suggestion', id=sug.id) }}" method="post">
                                            <button type="submit" class="btn btn-success btn-sm py-0 px-2" style="font-size: 0.75rem;">
                                                <i class="fas fa-check me-1"></i> Accept
                                            </button>
                                        </form>
                                        <form action="{{ url_for('main.ignore_stage_suggestion', id=sug.id) }}" method="post">
                                            <button type="submit" class="btn btn-outline-secondary btn-sm py-0 px-2" style="font-size: 0.75rem;">Ignore</button>
                                        </form>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            {% endif %}

            {% if (decision.owner == current_user or current_user.is_admin) %}
                {% set pending_clarifications = decision.clarifications.filter_by(status='pending').all() %}
                {% if pending_clarifications %}
            <section class="mb-4">
                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="card border-info border-opacity-25 shadow-sm h-100">
                            <div class="card-header bg-info bg-opacity-10 border-info border-opacity-25">
                                <h2 class="h6 mb-0 text-info"><i class="fas fa-question-circle me-2"></i>Pending Clarification Requests</h2>
                            </div>
                            <div class="list-group list-group-flush">
                                {% for clar in pending_clarifications %}
                                <div class="list-group-item p-3">
                                    <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                                        <a href="{{ url_for('main.user', username=clar.author.username) }}" class="badge bg-info text-white rounded-pill text-decoration-none" title="View Profile">
                                            <i class="fas fa-user me-1"></i> {{ clar.author.username }}
                                        </a>
                                        <small class="text-muted">{{ clar.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <p class="mb-3 small">"{{ clar.message }}"</p>
                                    <div class="d-flex gap-2">
                                        <form action="{{ url_for('main.apply_clarification', id=clar.id) }}" method="post">
                                            <button type="submit" class="btn btn-success btn-sm py-0 px-2" style="font-size: 0.75rem;">
                                                <i class="fas fa-check me-1"></i> Applied
                                            </button>
                                        </form>
                                        <form action="{{ url_for('main.ignore_clarification', id=clar.id) }}" method="post">
                                            <button type="submit" class="btn btn-outline-secondary btn-sm py-0 px-2" style="font-size: 0.75rem;">Ignore</button>
                                        </form>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>
                {% endif %}
            {% endif %}

            {% if current_user.is_authenticated and decision.is_public and (decision.owner != current_user and not current_user.is_admin) %}
            <div class="alert alert-info shadow-sm mb-4">
                <i class="fas fa-info-circle me-2"></i> You are viewing a <strong>public decision</strong> shared by <strong><a href="{{ url_for('main.user', username=decision.owner.username) }}" class="alert-link">{{ decision.owner.username }}</a></strong>.
            </div>
            {% elif current_user.is_anonymous and decision.is_public %}
            <div class="alert alert-info shadow-sm mb-4">
                <i class="fas fa-info-circle me-2"></i> You are viewing a <strong>public decision</strong> shared by <strong><a href="{{ url_for('main.user', username=decision.owner.username) }}" class="alert-link">{{ decision.owner.username }}</a></strong>. <a href="{{ url_for('auth.login') }}" class="alert-link">Login</a> to contribute!
            </div>
            {% endif %}

            <hr class="my-4">

            <section class="mb-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="h4 mb-0"><i class="fas fa-list-ul me-2 text-primary"></i>1. Options</h2>
                    {% if current_user.is_authenticated and (decision.owner == current_user or current_user.is_admin) %}
                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#aiAssistantCollapse">
                        <i class="fas fa-robot me-1"></i> AI Suggestions
                    </button>
                    {% endif %}
                </div>

                {% if current_user.is_authenticated and (decision.owner == current_user or current_user.is_admin) %}
                <div class="collapse mb-4" id="aiAssistantCollapse">
                    <div class="card ai-assistant-card border-0 p-4 shadow-sm">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h3 class="h5 mb-0"><i class="fas fa-robot me-2 text-primary"></i>AI Assistant Suggestions</h3>
                            <button type="button" class="btn-close" data-bs-toggle="collapse" data-bs-target="#aiAssistantCollapse" aria-label="Close"></button>
                        </div>
                        <p class="small text-muted mb-4">Need more ideas? Let AI suggest some alternative options based on your decision goal.</p>
                        <div class="d-grid gap-2 d-md-flex">
                            <button id="suggest-btn" class="btn btn-primary" onclick="getAiSuggestions()">
                                <i class="fas fa-lightbulb me-2"></i>Suggest Options
                            </button>
                        </div>
                        <div id="ai-suggestions" class="mt-4"></div>
                    </div>
                </div>
                {% endif %}
                {% if decision.options.count() > 0 %}
                <div class="list-group shadow-sm">
                    {% for option in decision.options.all() %}
                    <div class="list-group-item p-4">
                        <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                            <h5 class="mb-1 fw-bold">{{ option.title }}</h5>
                            {% if current_user.is_authenticated and (decision.owner == current_user or current_user.is_admin) %}
                            <div class="btn-group">
                                <a href="{{ url_for('main.edit_option', id=option.id) }}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                <form action="{{ url_for('main.delete_option', id=option.id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this option?');">
                                    <button type="submit" class="btn btn-outline-danger btn-sm rounded-start-0">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                        <p class="mb-3">{{ option.description }}</p>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="p-2 bg-success bg-opacity-10 border border-success border-opacity-25 rounded h-100">
                                    <small class="text-success fw-bold d-block mb-1"><i class="fas fa-plus-circle me-1"></i> Pros</small>
                                    <small>{{ option.pros or 'None listed' }}</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-2 bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded h-100">
                                    <small class="text-danger fw-bold d-block mb-1"><i class="fas fa-minus-circle me-1"></i> Cons</small>
                                    <small>{{ option.cons or 'None listed' }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-light border border-dashed py-4 text-center">
                    <p class="text-muted mb-0">No options added yet. Use the form below or AI suggestions to get started.</p>
                </div>
                {% endif %}
            </section>

            {% if decision.owner == current_user or current_user.is_admin %}
                {% set pending_suggestions = decision.suggestions.filter_by(status='pending').all() %}
                {% if pending_suggestions %}
                <section class="mb-5">
                    <h2 class="h4 mb-4"><i class="fas fa-lightbulb me-2 text-warning"></i>Member Suggestions</h2>
                    <div class="list-group shadow-sm mb-4">
                        {% for suggestion in pending_suggestions %}
                        <div class="list-group-item p-4 border-warning border-opacity-25">
                            <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                                <h5 class="mb-1 fw-bold">{{ suggestion.title }}</h5>
                                <a href="{{ url_for('main.user', username=suggestion.author.username) }}" class="badge bg-warning text-dark rounded-pill text-decoration-none" title="View Profile">
                                    <i class="fas fa-user me-1"></i> From: {{ suggestion.author.username }}
                                </a>
                            </div>
                            <p class="mb-3">{{ suggestion.description }}</p>
                            <div class="row g-2 mb-3">
                                <div class="col-md-6">
                                    <div class="p-2 bg-success bg-opacity-10 border border-success border-opacity-25 rounded h-100">
                                        <small class="text-success fw-bold d-block mb-1">Pros</small>
                                        <small>{{ suggestion.pros or 'None listed' }}</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="p-2 bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded h-100">
                                        <small class="text-danger fw-bold d-block mb-1">Cons</small>
                                        <small>{{ suggestion.cons or 'None listed' }}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <form action="{{ url_for('main.accept_suggestion', id=suggestion.id) }}" method="post">
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="fas fa-check me-1"></i> Accept & Add as Option
                                    </button>
                                </form>
                                <form action="{{ url_for('main.ignore_suggestion', id=suggestion.id) }}" method="post">
                                    <button type="submit" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-times me-1"></i> Ignore
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}
            {% endif %}

                {% if current_user.is_authenticated and (decision.owner == current_user or current_user.is_admin) %}
                <section class="card border-0 bg-light p-4 mb-5 shadow-sm">
                    <h3 class="h5 mb-4"><i class="fas fa-plus-square me-2 text-primary"></i>Add New Option</h3>
                    <form action="{{ url_for('main.add_option', id=decision.id) }}" method="post" class="row g-3">
                        {{ option_form.hidden_tag() }}
                        <div class="col-12">
                            {{ option_form.title.label(class="form-label fw-bold") }}
                            <div class="input-group">
                                {{ option_form.title(class="form-control", placeholder="e.g., Option Name", id="option_title") }}
                                <button class="btn btn-outline-primary" type="button" id="refine-option-btn" onclick="refineOption()">
                                    <i class="fas fa-magic me-1"></i> AI Refine
                                </button>
                            </div>
                        </div>
                        <div class="col-12">
                            {{ option_form.description.label(class="form-label fw-bold") }}
                            {{ option_form.description(class="form-control", rows=2, placeholder="Brief description...", id="option_description") }}
                        </div>
                        <div class="col-md-6">
                            {{ option_form.pros.label(class="form-label fw-bold text-success") }}
                            {{ option_form.pros(class="form-control", rows=2, placeholder="Points in favor...", id="option_pros") }}
                        </div>
                        <div class="col-md-6">
                            {{ option_form.cons.label(class="form-label fw-bold text-danger") }}
                            {{ option_form.cons(class="form-control", rows=2, placeholder="Points against...", id="option_cons") }}
                        </div>
                        <div class="col-12 text-end">
                            <button type="submit" class="btn btn-primary px-4">Add Option</button>
                        </div>
                    </form>
                </section>
                {% elif current_user.is_authenticated and decision.is_public %}
                <div class="alert alert-light border border-dashed py-4 text-center mb-5">
                    <p class="text-muted mb-0">Only the owner can add or edit options for this decision.</p>
                </div>
                {% endif %}
        </div>
    </div>

    <script>
    function getAiSuggestions() {
        const btn = document.getElementById('suggest-btn');
        const container = document.getElementById('ai-suggestions');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Consulting AI...';
        container.innerHTML = '<div class="text-center py-3"><div class="spinner-grow text-primary spinner-grow-sm"></div> <small class="text-muted ms-2 italic">Thinking...</small></div>';

        fetch("{{ url_for('main.suggest_options', id=decision.id) }}")
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-lightbulb me-2"></i>Suggest More Options';
                if (data.suggestions && data.suggestions.length > 0) {
                    let html = '<div class="list-group list-group-flush">';
                    data.suggestions.forEach((s, index) => {
                        html += `
                            <div class="list-group-item bg-transparent px-0 border-bottom">
                                <h6 class="mb-1 fw-bold">${s.title}</h6>
                                <p class="small text-muted mb-2">${s.description}</p>
                                <button class="btn btn-sm btn-link text-decoration-none p-0 fw-bold" onclick="fillOptionForm('${s.title.replace(/'/g, "\\'")}', '${s.description.replace(/'/g, "\\'")}', '${s.pros.replace(/'/g, "\\'")}', '${s.cons.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-plus-circle me-1"></i> Use suggestion
                                </button>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="alert alert-warning py-2 small">AI couldn\'t generate suggestions at this time.</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-lightbulb me-2"></i>Suggest Options';
                container.innerHTML = '<div class="alert alert-danger py-2 small">Error contacting AI service.</div>';
            });
    }

    function fillOptionForm(title, desc, pros, cons) {
        document.getElementById('option_title').value = title;
        document.getElementById('option_description').value = desc;
        document.getElementById('option_pros').value = pros;
        document.getElementById('option_cons').value = cons;
        window.scrollTo({
            top: document.getElementById('option_title').offsetTop - 100,
            behavior: 'smooth'
        });
    }

    function refineOption() {
        const title = document.getElementById('option_title').value;
        if (!title) {
            alert("Please enter an option title first.");
            return;
        }
        const btn = document.getElementById('refine-option-btn');
        const oldHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Refining...';

        fetch("{{ url_for('main.refine_option', id=decision.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ title: title }),
        })
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.innerText = 'AI Suggest Details';
            if (data.description) {
                document.getElementById('option_description').value = data.description;
                document.getElementById('option_pros').value = data.pros;
                document.getElementById('option_cons').value = data.cons;
            } else {
                alert("AI couldn't suggest details at this time.");
            }
        })
        .catch(error => {
            console.error('Error:', error);
            btn.disabled = false;
            btn.innerText = 'AI Suggest Details';
            alert("Error contacting AI service.");
        });
    }
    </script>
{% endblock %}

{% block scripts %}
<script>
    const quills = {};
    const suggestQuills = {};

    function toggleEdit(stageKey) {
        const editDiv = document.getElementById(`edit-${stageKey}`);
        const displayDiv = document.getElementById(`display-${stageKey}`);
        const comparisonDiv = document.getElementById(`ai-comparison-${stageKey}`);
        
        if (editDiv.classList.contains('d-none')) {
            editDiv.classList.remove('d-none');
            displayDiv.classList.add('d-none');
            comparisonDiv.classList.add('d-none');
            
            if (!quills[stageKey]) {
                quills[stageKey] = new Quill(`#editor-${stageKey}`, {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['clean']
                        ]
                    }
                });
                
                // Set initial content if exists
                const contentDiv = displayDiv.querySelector('.p-3.bg-light.rounded.border');
                if (contentDiv) {
                    quills[stageKey].root.innerHTML = contentDiv.innerHTML;
                }
            }
        } else {
            editDiv.classList.add('d-none');
            displayDiv.classList.remove('d-none');
        }
    }

    function toggleSuggest(stageKey) {
        const suggestDiv = document.getElementById(`suggest-${stageKey}`);
        const displayDiv = document.getElementById(`display-${stageKey}`);
        
        if (suggestDiv.classList.contains('d-none')) {
            suggestDiv.classList.remove('d-none');
            
            if (!suggestQuills[stageKey]) {
                suggestQuills[stageKey] = new Quill(`#suggest-editor-${stageKey}`, {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['clean']
                        ]
                    }
                });
            }
        } else {
            suggestDiv.classList.add('d-none');
        }
    }

    function saveStage(stageKey) {
        const content = quills[stageKey].root.innerHTML;
        
        fetch("{{ url_for('main.update_stage_content', id=decision.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                stage_key: stageKey,
                content: content
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.hash = `heading${stageKey.split('_')[0]}`;
                location.reload();
            } else {
                alert("Error: " + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Error saving stage content.");
        });
    }

    function submitSuggestion(stageKey) {
        const content = suggestQuills[stageKey].root.innerHTML;
        
        fetch("{{ url_for('main.suggest_stage_content', id=decision.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                stage_key: stageKey,
                content: content
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                toggleSuggest(stageKey);
            } else {
                alert("Error: " + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Error submitting suggestion.");
        });
    }

    function aiAssist(stageKey) {
        const btn = document.getElementById(`ai-btn-${stageKey}`);
        const oldHtml = btn.innerHTML;
        
        // Get current content from Quill if it exists, otherwise from display div
        let currentContent = "";
        if (quills[stageKey]) {
            currentContent = quills[stageKey].root.innerHTML;
        } else {
            const displayDiv = document.getElementById(`display-${stageKey}`);
            const contentDiv = displayDiv.querySelector('.p-3.bg-light.rounded.border');
            if (contentDiv) {
                currentContent = contentDiv.innerHTML;
            }
        }
        
        // Check if content is truly empty (excluding default empty p tags)
        const isContentEmpty = !currentContent || currentContent === '<p><br></p>' || currentContent.trim() === '';
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>AI Thinking...';

        fetch("{{ url_for('main.ai_assist_stage', id=decision.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                stage_key: stageKey,
                content: currentContent
            }),
        })
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = oldHtml;
            if (data.suggestion) {
                // Show side-by-side comparison for all suggestions
                const comparisonDiv = document.getElementById(`ai-comparison-${stageKey}`);
                const suggestionContent = document.getElementById(`ai-suggestion-content-${stageKey}`);
                const displayDiv = document.getElementById(`display-${stageKey}`);
                
                suggestionContent.innerHTML = data.suggestion;
                comparisonDiv.classList.remove('d-none');
                displayDiv.classList.add('d-none');
                
                // Close edit mode if open
                const editDiv = document.getElementById(`edit-${stageKey}`);
                if (!editDiv.classList.contains('d-none')) {
                    toggleEdit(stageKey);
                }
            } else {
                alert("AI Error: " + (data.error || "Unknown error"));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            btn.disabled = false;
            btn.innerHTML = oldHtml;
            alert("Error contacting AI service.");
        });
    }

    function applyAiSuggestion(stageKey) {
        const suggestionContent = document.getElementById(`ai-suggestion-content-${stageKey}`).innerHTML;
        
        // Get current content
        let currentContent = "";
        const displayDiv = document.getElementById(`display-${stageKey}`);
        const contentDiv = displayDiv.querySelector('.p-3.bg-light.rounded.border');
        if (contentDiv) {
            currentContent = contentDiv.innerHTML;
        }
        
        const isCurrentEmpty = !currentContent || currentContent === '<p><br></p>' || currentContent.trim() === '';
        let mergedContent = "";
        
        if (isCurrentEmpty) {
            mergedContent = suggestionContent;
        } else {
            // Append with a separator
            mergedContent = currentContent + '<hr><p><strong>AI Suggestion:</strong></p>' + suggestionContent;
        }

        // Save directly
        fetch("{{ url_for('main.update_stage_content', id=decision.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                stage_key: stageKey,
                content: mergedContent
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.hash = `heading${stageKey.split('_')[0]}`;
                location.reload();
            } else {
                alert("Error: " + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Error saving stage content.");
        });
    }

    function closeAiComparison(stageKey) {
        const comparisonDiv = document.getElementById(`ai-comparison-${stageKey}`);
        const displayDiv = document.getElementById(`display-${stageKey}`);
        comparisonDiv.classList.add('d-none');
        displayDiv.classList.remove('d-none');
    }

    // Handle focus on stage from hash
    document.addEventListener('DOMContentLoaded', function() {
        if (window.location.hash) {
            const targetId = window.location.hash.substring(1); // remove #
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                // Find the button inside the heading and click it to open the accordion
                const button = targetElement.querySelector('.accordion-button');
                if (button && button.classList.contains('collapsed')) {
                    button.click();
                }
                // Scroll to it
                setTimeout(() => {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
            }
        }
    });
</script>
{% endblock %}
