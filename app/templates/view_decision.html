{% extends "base.html" %}

{% block content %}
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ decision.title }}</li>
                </ol>
            </nav>

            <div class="decision-header-card p-4 p-md-5 mb-5 shadow-sm border-0">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
                    <div>
                        <h1 class="h2 fw-bold mb-0">{{ decision.title }}</h1>
                    </div>
                    {% if decision.owner == current_user or current_user.is_admin %}
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('main.edit_decision', id=decision.id) }}" class="btn btn-primary shadow-sm">
                            <i class="fas fa-edit me-1"></i> Edit
                        </a>
                        <form action="{{ url_for('main.delete_decision', id=decision.id, next=url_for('main.index')) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this ENTIRE decision process? This cannot be undone.');">
                            <button type="submit" class="btn btn-outline-danger shadow-sm">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>

                <div class="d-flex flex-wrap align-items-center gap-2 mt-4">
                    <span class="badge bg-light text-secondary border px-3 py-2">
                        <i class="far fa-calendar-alt me-1 text-primary"></i> Deadline: {{ decision.deadline.strftime('%Y-%m-%d') if decision.deadline else 'Not set' }}
                    </span>
                    <span class="badge bg-primary-subtle text-primary border border-primary-subtle px-3 py-2">
                        <i class="fas fa-tasks me-1"></i> Stage: 
                        {% for value, label in decision.STAGES %}
                            {% if value == decision.stage %}
                                {{ label }}
                            {% endif %}
                        {% endfor %}
                    </span>
                    <span class="badge {% if decision.status == 'completed' %}bg-success text-white{% else %}bg-secondary text-white{% endif %} px-3 py-2">
                        <i class="fas fa-info-circle me-1"></i> Status: {{ decision.status|capitalize }}
                    </span>
                    {% if decision.category %}
                    <a href="{{ url_for('main.index', category=decision.category) }}" class="badge rounded-pill bg-light text-primary border shadow-sm px-3 py-2 text-decoration-none hover-shadow">
                        <i class="fas fa-tag me-1"></i> {{ decision.category }}
                    </a>
                    {% endif %}
                    {% if decision.is_public %}
                    <span class="badge rounded-pill bg-info text-white shadow-sm px-3 py-2">
                        <i class="fas fa-globe me-1"></i> Public
                    </span>
                    {% endif %}
                </div>
            </div>

            <section class="mb-5">
                <h2 class="h4 mb-4"><i class="fas fa-tasks me-2 text-primary"></i>Decision Stages Details</h2>
                <div class="accordion shadow-sm" id="stagesAccordion">
                    {% for value, label in stages %}
                    {% set stage_num = value.split('_')[0] %}
                    {% set stage_content_attr = 'stage_' + value %}
                    {% set stage_content = getattr(decision, stage_content_attr) %}
                    <div class="accordion-item border mb-3 rounded-1 overflow-hidden">
                        <h2 class="accordion-header" id="heading{{ stage_num }}">
                            <button class="accordion-button {% if not stage_content %}collapsed{% endif %} py-4 px-4" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ stage_num }}" aria-expanded="{% if stage_content %}true{% else %}false{% endif %}" aria-controls="collapse{{ stage_num }}">
                                <span class="badge {% if decision.stage == value %}bg-primary{% else %}bg-secondary{% endif %} me-3 rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; padding: 0;">{{ stage_num }}</span>
                                <span class="fw-bold fs-5 {% if decision.stage == value %}text-primary{% endif %}">{{ label }}</span>
                                {% if decision.stage == value %}
                                <span class="badge bg-primary-subtle text-primary border border-primary-subtle ms-3 small py-1 px-2">Current Stage</span>
                                {% endif %}
                            </button>
                        </h2>
                        <div id="collapse{{ stage_num }}" class="accordion-collapse collapse {% if stage_content %}show{% endif %}" aria-labelledby="heading{{ stage_num }}" data-bs-parent="#stagesAccordion">
                            <div class="accordion-body bg-white p-4">
                                <div class="row">
                                    <div class="col-lg-4">
                                        <div class="d-flex align-items-center mb-3">
                                            {% if stage_content %}
                                            <div class="text-success me-3" title="Content added">
                                                <i class="fas fa-check-circle fa-lg"></i> <span class="small fw-bold">Content added</span>
                                            </div>
                                            {% endif %}
                                            {% if decision.stage != value and (decision.owner == current_user or current_user.is_admin) %}
                                            <form action="{{ url_for('main.set_current_stage', id=decision.id) }}" method="post" class="d-inline-block">
                                                <input type="hidden" name="stage_key" value="{{ value }}">
                                                <button type="submit" class="btn btn-outline-primary btn-sm py-1 px-3" style="font-size: 0.8rem;">Set to current stage</button>
                                            </form>
                                            {% endif %}
                                        </div>
                                        <!-- Stage Guidance -->
                                        {% if stage_details and value in stage_details %}
                                        <div class="stage-guidance mb-4 p-3 bg-light border-start border-primary border-4 rounded-end">
                                            <h5 class="h6 fw-bold text-primary mb-2">{{ stage_details[value]['quote'] }}</h5>
                                            <ul class="small text-muted mb-2 ps-3">
                                                {% for bullet in stage_details[value]['bullets'] %}
                                                <li>{{ bullet }}</li>
                                                {% endfor %}
                                            </ul>
                                            <div class="small text-danger mt-2">
                                                <i class="fas fa-exclamation-triangle me-1"></i> <strong>Risk here:</strong> {{ stage_details[value]['risk'] }}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-lg-8">
                                        <div id="display-{{ value }}" class="stage-display mb-3">
                                            {% if stage_content %}
                                                <div class="p-3 bg-light rounded border">
                                                    {{ stage_content|safe }}
                                                </div>
                                            {% else %}
                                                <p class="text-muted italic">No content yet for this stage.</p>
                                            {% endif %}
                                        </div>

                                        <div id="ai-comparison-{{ value }}" class="ai-comparison d-none mb-3">
                                            <div class="card border-magic">
                                                <div class="card-header bg-magic text-white d-flex justify-content-between align-items-center">
                                                    <span><i class="fas fa-robot me-2"></i>AI Suggested Improvement</span>
                                                    <button type="button" class="btn-close btn-close-white" onclick="closeAiComparison('{{ value }}')" aria-label="Close"></button>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row g-3">
                                                        <div class="col-md-6">
                                                            <h6 class="fw-bold text-muted mb-2">Current Content</h6>
                                                            <div class="p-3 border rounded bg-light small" style="max-height: 300px; overflow-y: auto;">
                                                                {% if stage_content %}
                                                                    {{ stage_content|safe }}
                                                                {% else %}
                                                                    <span class="text-muted italic">Empty</span>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <h6 class="fw-bold text-magic mb-2">AI Suggestion</h6>
                                                            <div id="ai-suggestion-content-{{ value }}" class="p-3 border border-magic rounded bg-magic-subtle small" style="max-height: 300px; overflow-y: auto;">
                                                                <!-- AI content goes here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex gap-2 mt-3 justify-content-end">
                                                        <button class="btn btn-outline-secondary btn-sm" onclick="closeAiComparison('{{ value }}')">Discard</button>
                                                        <button class="btn btn-magic btn-sm" id="apply-ai-{{ value }}" onclick="applyAiSuggestion('{{ value }}')">
                                                            <i class="fas fa-check me-1"></i> Use Suggestion
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {% if decision.owner == current_user or current_user.is_admin %}
                                        {% if decision.owner == current_user %}
                                            {% set stage_suggestions = decision.stage_suggestions.filter_by(stage_key=value, status='pending').all() %}
                                            {% if stage_suggestions %}
                                            <div class="stage-suggestions-contextual mb-3">
                                                <h6 class="fw-bold text-warning small mb-2"><i class="fas fa-lightbulb me-1"></i>Pending Suggestions for this Stage:</h6>
                                                {% for sug in stage_suggestions %}
                                                <div class="card border-warning border-opacity-25 mb-2 shadow-sm">
                                                    <div class="card-body p-2 small">
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <a href="{{ url_for('main.user', username=sug.author.username) }}" class="fw-bold text-decoration-none">
                                                                {{ sug.author.username }}
                                                            </a>
                                                            <span class="text-muted" style="font-size: 0.7rem;">{{ sug.created_at.strftime('%Y-%m-%d') }}</span>
                                                        </div>
                                                        <div class="mb-2 border p-2 bg-light rounded" style="max-height: 80px; overflow-y: auto;">
                                                            {{ sug.content|safe }}
                                                        </div>
                                                        <div class="d-flex gap-2">
                                                            <form action="{{ url_for('main.accept_stage_suggestion', id=sug.id) }}" method="post">
                                                                <button type="submit" class="btn btn-success btn-sm py-0 px-2" style="font-size: 0.7rem;">
                                                                    <i class="fas fa-check me-1"></i> Accept
                                                                </button>
                                                            </form>
                                                            <form action="{{ url_for('main.ignore_stage_suggestion', id=sug.id) }}" method="post">
                                                                <button type="submit" class="btn btn-outline-secondary btn-sm py-0 px-2" style="font-size: 0.7rem;">Ignore</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        {% endif %}
                                        
                                        <div id="edit-{{ value }}" class="stage-edit d-none">
                                            <div id="editor-{{ value }}" style="height: 200px;" class="mb-3"></div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-primary btn-sm" onclick="saveStage('{{ value }}')">
                                                    <i class="fas fa-save me-1"></i> Save
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm" onclick="toggleEdit('{{ value }}')">Cancel</button>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2 mt-3">
                                            <button class="btn btn-outline-primary btn-sm" onclick="toggleEdit('{{ value }}')">
                                                <i class="fas fa-edit me-1"></i> {% if stage_content %}Edit{% else %}Add Content{% endif %}
                                            </button>
                                            <button class="btn btn-outline-magic btn-sm" id="ai-btn-{{ value }}" onclick="aiAssist('{{ value }}')">
                                                <i class="fas fa-magic me-1"></i> AI Assist
                                            </button>
                                            {% if current_user.is_admin and decision.owner != current_user %}
                                            <button class="btn btn-outline-warning btn-sm" onclick="toggleSuggest('{{ value }}')">
                                                <i class="fas fa-lightbulb me-1"></i> Suggest Improvement
                                            </button>
                                            {% endif %}
                                        </div>

                                        {% if current_user.is_admin and decision.owner != current_user %}
                                        <div id="suggest-{{ value }}" class="stage-suggest d-none mt-3">
                                            <div id="suggest-editor-{{ value }}" style="height: 200px;" class="mb-3"></div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-warning btn-sm" onclick="submitSuggestion('{{ value }}')">
                                                    <i class="fas fa-paper-plane me-1"></i> Submit Suggestion
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm" onclick="toggleSuggest('{{ value }}')">Cancel</button>
                                            </div>
                                        </div>
                                        {% endif %}

                                        {% elif current_user.is_authenticated %}
                                        <div id="suggest-{{ value }}" class="stage-suggest d-none">
                                            <div id="suggest-editor-{{ value }}" style="height: 200px;" class="mb-3"></div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-warning btn-sm" onclick="submitSuggestion('{{ value }}')">
                                                    <i class="fas fa-paper-plane me-1"></i> Submit Suggestion
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm" onclick="toggleSuggest('{{ value }}')">Cancel</button>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button class="btn btn-outline-warning btn-sm" onclick="toggleSuggest('{{ value }}')">
                                                <i class="fas fa-lightbulb me-1"></i> Suggest Improvement
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>


            {% if (decision.owner == current_user or current_user.is_admin) %}
                {% set pending_clarifications = decision.clarifications.filter_by(status='pending').all() %}
                {% if pending_clarifications %}
            <section class="mb-4">
                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="card border-info border-opacity-25 shadow-sm h-100">
                            <div class="card-header bg-info bg-opacity-10 border-info border-opacity-25">
                                <h2 class="h6 mb-0 text-info"><i class="fas fa-question-circle me-2"></i>Pending Clarification Requests</h2>
                            </div>
                            <div class="list-group list-group-flush">
                                {% for clar in pending_clarifications %}
                                <div class="list-group-item p-3">
                                    <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                                        <a href="{{ url_for('main.user', username=clar.author.username) }}" class="badge bg-info text-white rounded-pill text-decoration-none" title="View Profile">
                                            <i class="fas fa-user me-1"></i> {{ clar.author.username }}
                                        </a>
                                        <small class="text-muted">{{ clar.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <p class="mb-3 small">"{{ clar.message }}"</p>
                                    <div class="d-flex gap-2">
                                        <form action="{{ url_for('main.apply_clarification', id=clar.id) }}" method="post">
                                            <button type="submit" class="btn btn-success btn-sm py-0 px-2" style="font-size: 0.75rem;">
                                                <i class="fas fa-check me-1"></i> Applied
                                            </button>
                                        </form>
                                        <form action="{{ url_for('main.ignore_clarification', id=clar.id) }}" method="post">
                                            <button type="submit" class="btn btn-outline-secondary btn-sm py-0 px-2" style="font-size: 0.75rem;">Ignore</button>
                                        </form>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>
                {% endif %}
            {% endif %}

            {% if current_user.is_authenticated and decision.is_public and (decision.owner != current_user and not current_user.is_admin) %}
            <div class="alert alert-info shadow-sm mb-4">
                <i class="fas fa-info-circle me-2"></i> You are viewing a <strong>public decision</strong> shared by <strong><a href="{{ url_for('main.user', username=decision.owner.username) }}" class="alert-link">{{ decision.owner.username }}</a></strong>.
            </div>
            {% elif current_user.is_anonymous and decision.is_public %}
            <div class="alert alert-info shadow-sm mb-4">
                <i class="fas fa-info-circle me-2"></i> You are viewing a <strong>public decision</strong> shared by <strong><a href="{{ url_for('main.user', username=decision.owner.username) }}" class="alert-link">{{ decision.owner.username }}</a></strong>. <a href="{{ url_for('auth.login') }}" class="alert-link">Login</a> to contribute!
            </div>
            {% endif %}

            <hr class="my-4">
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        if (window.location.hash) {
            const targetId = window.location.hash.substring(1);
            const element = document.getElementById(targetId);
            if (element && element.classList.contains('collapse')) {
                const bsCollapse = new bootstrap.Collapse(element, {
                    toggle: true
                });
            }
        }
    });

    const quills = {};
    const suggestQuills = {};

    function toggleEdit(stageKey) {
        const editDiv = document.getElementById(`edit-${stageKey}`);
        const displayDiv = document.getElementById(`display-${stageKey}`);
        const comparisonDiv = document.getElementById(`ai-comparison-${stageKey}`);
        
        if (editDiv.classList.contains('d-none')) {
            editDiv.classList.remove('d-none');
            displayDiv.classList.add('d-none');
            comparisonDiv.classList.add('d-none');
            
            if (!quills[stageKey]) {
                quills[stageKey] = new Quill(`#editor-${stageKey}`, {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['clean']
                        ]
                    }
                });
                
                // Set initial content if exists
                const contentDiv = displayDiv.querySelector('.p-3.bg-light.rounded.border');
                if (contentDiv) {
                    quills[stageKey].root.innerHTML = contentDiv.innerHTML;
                }
            }
        } else {
            editDiv.classList.add('d-none');
            displayDiv.classList.remove('d-none');
        }
    }

    function toggleSuggest(stageKey) {
        const suggestDiv = document.getElementById(`suggest-${stageKey}`);
        const displayDiv = document.getElementById(`display-${stageKey}`);
        
        if (suggestDiv.classList.contains('d-none')) {
            suggestDiv.classList.remove('d-none');
            
            if (!suggestQuills[stageKey]) {
                suggestQuills[stageKey] = new Quill(`#suggest-editor-${stageKey}`, {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['clean']
                        ]
                    }
                });
            }
        } else {
            suggestDiv.classList.add('d-none');
        }
    }

    function saveStage(stageKey) {
        const content = quills[stageKey].root.innerHTML;
        
        fetch("{{ url_for('main.update_stage_content', id=decision.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                stage_key: stageKey,
                content: content
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.hash = `heading${stageKey.split('_')[0]}`;
                location.reload();
            } else {
                alert("Error: " + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Error saving stage content.");
        });
    }

    function submitSuggestion(stageKey) {
        const content = suggestQuills[stageKey].root.innerHTML;
        
        fetch("{{ url_for('main.suggest_stage_content', id=decision.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                stage_key: stageKey,
                content: content
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                toggleSuggest(stageKey);
            } else {
                alert("Error: " + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Error submitting suggestion.");
        });
    }

    function aiAssist(stageKey) {
        const btn = document.getElementById(`ai-btn-${stageKey}`);
        const oldHtml = btn.innerHTML;
        
        // Get current content from Quill if it exists, otherwise from display div
        let currentContent = "";
        if (quills[stageKey]) {
            currentContent = quills[stageKey].root.innerHTML;
        } else {
            const displayDiv = document.getElementById(`display-${stageKey}`);
            const contentDiv = displayDiv.querySelector('.p-3.bg-light.rounded.border');
            if (contentDiv) {
                currentContent = contentDiv.innerHTML;
            }
        }
        
        // Check if content is truly empty (excluding default empty p tags)
        const isContentEmpty = !currentContent || currentContent === '<p><br></p>' || currentContent.trim() === '';
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>AI Thinking...';

        fetch("{{ url_for('main.ai_assist_stage', id=decision.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                stage_key: stageKey,
                content: currentContent
            }),
        })
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = oldHtml;
            if (data.suggestion) {
                // Show side-by-side comparison for all suggestions
                const comparisonDiv = document.getElementById(`ai-comparison-${stageKey}`);
                const suggestionContent = document.getElementById(`ai-suggestion-content-${stageKey}`);
                const displayDiv = document.getElementById(`display-${stageKey}`);
                
                suggestionContent.innerHTML = data.suggestion;
                comparisonDiv.classList.remove('d-none');
                displayDiv.classList.add('d-none');
                
                // Close edit mode if open
                const editDiv = document.getElementById(`edit-${stageKey}`);
                if (!editDiv.classList.contains('d-none')) {
                    toggleEdit(stageKey);
                }
            } else {
                alert("AI Error: " + (data.error || "Unknown error"));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            btn.disabled = false;
            btn.innerHTML = oldHtml;
            alert("Error contacting AI service.");
        });
    }

    function applyAiSuggestion(stageKey) {
        const suggestionContent = document.getElementById(`ai-suggestion-content-${stageKey}`).innerHTML;
        
        // Get current content
        let currentContent = "";
        const displayDiv = document.getElementById(`display-${stageKey}`);
        const contentDiv = displayDiv.querySelector('.p-3.bg-light.rounded.border');
        if (contentDiv) {
            currentContent = contentDiv.innerHTML;
        }
        
        const isCurrentEmpty = !currentContent || currentContent === '<p><br></p>' || currentContent.trim() === '';
        let mergedContent = "";
        
        if (isCurrentEmpty) {
            mergedContent = suggestionContent;
        } else {
            // Append with a separator
            mergedContent = currentContent + '<hr><p><strong>AI Suggestion:</strong></p>' + suggestionContent;
        }

        // Save directly
        fetch("{{ url_for('main.update_stage_content', id=decision.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                stage_key: stageKey,
                content: mergedContent
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.hash = `heading${stageKey.split('_')[0]}`;
                location.reload();
            } else {
                alert("Error: " + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Error saving stage content.");
        });
    }

    function closeAiComparison(stageKey) {
        const comparisonDiv = document.getElementById(`ai-comparison-${stageKey}`);
        const displayDiv = document.getElementById(`display-${stageKey}`);
        comparisonDiv.classList.add('d-none');
        displayDiv.classList.remove('d-none');
    }

    // Handle focus on stage from hash
    document.addEventListener('DOMContentLoaded', function() {
        if (window.location.hash) {
            const targetId = window.location.hash.substring(1); // remove #
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                // Find the button inside the heading and click it to open the accordion
                const button = targetElement.querySelector('.accordion-button');
                if (button && button.classList.contains('collapsed')) {
                    button.click();
                }
                // Scroll to it
                setTimeout(() => {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
            }
        }
    });
</script>
{% endblock %}
